<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Kiara</title>
<style>
body { margin:0; background:#000; color:white; font-family:Arial; }
.header { padding:10px; display:flex; justify-content:space-between; background:#111; }
.chat { height:70vh; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:10px; }
.message { padding:10px; border-radius:8px; max-width:70%; }
.user { align-self:flex-end; background:#333; }
.ai { align-self:flex-start; background:#550022; }
.input-area { display:flex; padding:10px; background:#111; }
input { flex:1; padding:10px; }
button { padding:10px; cursor:pointer; }
.affection { height:20px; background:#222; margin:5px 10px; position:relative; }
.affection-bar { height:100%; width:0%; background:#ff1461; }
.affection-text { position:absolute; width:100%; text-align:center; font-size:12px; top:0; }
</style>
</head>
<body>

<div class="header">
  <div>KIARA</div>
  <div id="timer">05:00</div>
</div>

<div class="affection">
  <div class="affection-bar" id="affectionBar"></div>
  <div class="affection-text" id="affectionText">0%</div>
</div>

<div class="chat" id="chat"></div>

<div class="input-area">
  <input type="text" id="input" placeholder="Type your message">
  <button onclick="sendMessage()">Send</button>
</div>

<script>

const BACKEND = "https://lustlogic-backend.onrender.com/chat";
const GAME_TIME = 300;

let affection = 0;
let timeLeft = GAME_TIME;
let active = true;

const username = localStorage.getItem("lustlogic_wallet");

if (!username) {
  window.location.href = "index.html";
}

const chat = document.getElementById("chat");
const affectionBar = document.getElementById("affectionBar");
const affectionText = document.getElementById("affectionText");
const timer = document.getElementById("timer");
const input = document.getElementById("input");

function addMessage(text, type) {
  const div = document.createElement("div");
  div.className = "message " + type;
  div.innerText = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function updateAffection(value) {
  affection = value;
  affectionBar.style.width = affection + "%";
  affectionText.innerText = affection + "%";
}

function startTimer() {
  const interval = setInterval(() => {
    if (!active) return clearInterval(interval);

    timeLeft--;

    const min = Math.floor(timeLeft / 60);
    const sec = timeLeft % 60;

    timer.innerText =
      min.toString().padStart(2,"0") + ":" +
      sec.toString().padStart(2,"0");

    if (timeLeft <= 0) {
      active = false;
      alert("Time expired");
      window.location.href = "index.html";
    }
  },1000);
}

async function sendMessage() {
  if (!active) return;

  const message = input.value.trim();
  if (!message) return;

  addMessage(message,"user");
  input.value = "";

  try {
    const res = await fetch(BACKEND,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        wallet: username,
        message: message
      })
    });

    const data = await res.json();

    updateAffection(data.affection);
    addMessage(data.reply,"ai");

    if (data.win) {
      active = false;
      alert("You won!");
      window.location.href = "index.html";
    }

  } catch(err) {
    addMessage("Connection error","ai");
  }
}

input.addEventListener("keypress", e=>{
  if(e.key==="Enter") sendMessage();
});

addMessage("Hey " + username + "... I'm Kiara. Impress me.", "ai");

startTimer();

</script>

</body>
</html>
